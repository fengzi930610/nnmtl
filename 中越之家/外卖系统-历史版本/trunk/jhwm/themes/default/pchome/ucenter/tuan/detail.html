<{assign var="page_title" value="团购订单详情"}>
<{assign var='tpl_title' value=L("团购订单详情")}>
<{include file="pchome/block/header.html"}>
<{include file="pchome/block/top_nav.html"}>
<{include file="pchome/ucenter/block/top.html"}>
    <div class="minePage_bg bg_grey">
    	<div class="pagewd">
            <{include file="pchome/ucenter/block/left.html"}>
            <div class="minePage_cont fr">
            	<!--内容start-->
            	<div class="s purchase-orderParticulars mq-orderParticulars">
                    <div class="top-title">
                        团购订单&gt;<span class="maincl">订单详情</span>
                    </div> 
                    <div class="top-lg-box">
                        <div class="box-left fl">
                            <p class="haoma">订单号：<{$detail.order_id}></p>
                            <p class="status"><{$detail.order_status_label}></p>
                            <p class="sm-tip black9">（<{$detail.dateline|format:'Y-m-d H:i'}>下单）</p>
                            <{if $detail.order_status ==0 && $detail.pay_status == 0}>
                                <a href="<{link ctl='payment/pay' args=$detail.order_id}>" class="btn cuidan-btn active">立即支付</a>
                                <a href="javascript:void(0);" class="btn shengqing-btn active jq_cancel">取消订单</a>
                             <{elseif $detail.order_status == 0 &&$detail.pay_status == 1}>    
                                <a href="javascript:void(0);" class="btn shengqing-btn active jq_cancel">申请退款</a>
                            <{elseif $detail.order_status == 8 &&$detail.comment_status == 0}>    
                                <a href="javascript:void(0);" id="dianping_btn" class="btn cuidan-btn active">立即评价</a>
                            <{else}>
                                <{$detail.order_status_warning}>
                            <{/if}>
                        </div>
                        <div class="box-right fl">
                            <div class="process">
                                <div class="box box-first">
                                    <div class="cir active">1</div>
                                    <div class="text txt-active">
                                        <p>提交订单</p>
                                        <p><{$detail.dateline|format:'Y-m-d'}></p>
                                        <p><{$detail.dateline|format:'H:i:s'}></p>
                                    </div>
                                </div>
                                <{if $detail.pay_time>0}>
                                <div class="box">
                                    <div class="cir active">2</div>
                                    <div class="text txt-active">
                                       <p>付款成功</p> 
                                       <p><{$detail.pay_time|format:'Y-m-d'}></p>
                                       <p><{$detail.pay_time|format:'H:i:s'}></p>
                                    </div>
                                </div>
                                <div class="box">
                                    <div class="cir active">3</div>
                                    <div class="text txt-active">
                                       <p>待消费</p> 
                                    </div>
                                </div>
                                <{if $detail.order_status == 8}>
                                        <div class="box box-last">
                                            <div class="cir active">4</div>
                                            <div class="text txt-active">
                                                <p>已完成</p>
                                                <p><{$detail.lasttime|format:'Y-m-d'}></p>
                                                <p><{$detail.lasttime|format:'H:i:s'}></p>
                                            </div>
                                        </div>
                                    <{elseif $detail.order_status == -1}>
                                        <div class="box box-last">
                                            <div class="cir active">4</div>
                                            <div class="text txt-active">
                                                <p>已取消</p>
                                                <p><{$detail.lasttime|format:'Y-m-d'}></p>
                                                <p><{$detail.lasttime|format:'H:i:s'}></p>
                                            </div>
                                        </div>
                                    <{else}>
                                        <div class="box box-last">
                                            <div class="cir">4</div>
                                            <div class="text">
                                                <p>已完成</p>
                                            </div>
                                        </div>
                                    <{/if}>
                                <{else}>
                                    <div class="box">
                                        <div class="cir">2</div>
                                        <div class="text">
                                           <p>等待付款</p> 
                                        </div>
                                    </div>
                                    <div class="box">
                                        <div class="cir">3</div>
                                        <div class="text">
                                           <p>待消费</p> 
                                        </div>
                                    </div>
                                    <{if $detail.order_status == 8}>
                                        <div class="box box-last">
                                            <div class="cir active">4</div>
                                            <div class="text txt-active">
                                                <p>已完成</p>
                                                <p><{$detail.lasttime|format:'Y-m-d'}></p>
                                                <p><{$detail.lasttime|format:'H:i:s'}></p>
                                            </div>
                                        </div>
                                    <{elseif $detail.order_status == -1}>
                                        <div class="box box-last">
                                            <div class="cir active">4</div>
                                            <div class="text txt-active">
                                                <p>已取消</p>
                                                <p><{$detail.lasttime|format:'Y-m-d'}></p>
                                                <p><{$detail.lasttime|format:'H:i:s'}></p>
                                            </div>
                                        </div>
                                    <{else}>
                                        <div class="box box-last">
                                            <div class="cir">4</div>
                                            <div class="text">
                                                <p>已完成</p>
                                            </div>
                                        </div>
                                    <{/if}>
                                <{/if}>
                            </div>
                        </div>
                        <div class="clear"></div>
                    </div> 
                    <div class="mid-box">
                        <div class="sm-tit">团购券</div>
                        <div class="information">
                            <p class="tit black9">小提示：记下或拍下团购券码向商家出示即可消费，无需等待短信</p>
                            <p>团购券:<a href="javascript:void(0);" class="quan"><{$quan.number}></a>x<{$tuan_order.tuan_number}><span class="black9"><{if $quan.status == 0}>未使用<{elseif $quan.status == 1}>已使用<{elseif $quan.status == -1}>已退款<{/if}></span></p>
                            <p class="last">有效期至：<span><{$tuan_order.ltime|format:'Y-m-d H:i'}></span></p>
                        </div>
                    </div>
                    <div class="bottom-box">
                        <div class="tit">团购详情</div>
                        <table>
                            <tr>
                                <th class="mingcheng">团购项目</th>
                                <th class="num">数量</th>
                                <th class="danjia">单价</th>
                                <th class="zong ">支付总金额</th>
                            </tr>
                            <tr>
                                <td class="maincl"><{$tuan_order.tuan_title}></td>
                                <td><{$tuan_order.tuan_number}></td>
                                <td>¥<{$tuan_order['tuan_price']/$tuan_order['tuan_number']}></td>
                                <td class="jifen-detail"><span>¥<{$tuan_order['tuan_price']}></span></td>
                            </tr>
                        </table>
                    </div>
                </div>
                <!--内容end-->
            </div>
            <div class="clear"></div>
        </div>
    </div>
    <!--评价弹出层-->
    <div class="mask_bg"></div>
    <div class="shangjia_evlt_mask shangjia_evlt_mask_box">
    	<div class="tit">评价</div>
        <div class="cont">
        <form action="<{link ctl='ucenter/order/comment_handle' }>" mini-form="car-form" id="comment_form" method="post">
            <script>
                function fileSelected(obj, type) {
                    var files = obj.files;
                    for (var i = 0; i < files.length; i++) {
                        var tag = '';
                        var rFilter = /^(image\/gif|image\/jpeg|image\/jpg|image\/png)$/i;
                        if (!rFilter.test(files[i].type)) {
                            alert("只允许上传JPG、PNG、GIF格式图片");
                            return false;
                        }
                        var reader = new FileReader();
                        reader.onloadstart = function (e) {
                            $(".loading").show();
                        }
                        reader.onload = function (e) {
                            $('#photo' + type).hide();
                            $("#img" + type).attr("src", e.target.result).show();  //图片编码字符串
                        }
                        reader.readAsDataURL(files[i]);
                    }
                }
            </script>
            	<div class="star_box mb20">
                	<span class="fl">总体评价</span>
                    <div class="starCz_bg fl">
                    	<div class="starCz_bar" style="width:60%;"></div>
                        <div class="click">
                            <a href="javascript:void(0);" rel="1"></a>
                            <a href="javascript:void(0);" rel="2"></a>
                            <a href="javascript:void(0);" rel="3"></a>
                            <a href="javascript:void(0);" rel="4"></a>
                            <a href="javascript:void(0);" rel="5"></a>
                            <input type='hidden' name="data[score]" id="score" value="3">
                        </div>
                    </div>
                </div>
                <div class="textarea_box mb20">
                    <textarea name="data[content]" id="content" placeholder="您对Ta的的印象"></textarea>
                </div>
                <div class="img_box mb10">
                	<a href="javascript:void(0);" class="img_upload">
                            <input type="file" name="photo1" id="photo1" onchange="fileSelected(this, 1)" value="上传"   />
                            <img src="" id="img1" style="display:none;" width="100%" height="100%" />
                        </a>
                        <a href="javascript:void(0);" class="img_upload">
                            <input type="file" name="photo2" id="photo2" onchange="fileSelected(this, 2)" value="上传"   />
                            <img src="" id="img2" style="display:none;" width="100%" height="100%" />
                        </a>
                        <a href="javascript:void(0);" class="img_upload">
                            <input type="file" name="photo3" id="photo3" onchange="fileSelected(this, 3)" value="上传"   />
                            <img src="" id="img3" style="display:none;" width="100%" height="100%" />
                        </a>
                        <a href="javascript:void(0);" class="img_upload">
                            <input type="file" name="photo4" id="photo4" onchange="fileSelected(this, 4)" value="上传"   />
                            <img src="" id="img4" style="display:none;" width="100%" height="100%" />
                        </a>
                </div>
                <div class="btn_box">
                    <input type="hidden" name="data[order_id]" id="order_id" value="<{$detail.order_id}>"/>
                    <input type="button" class="btn cancel" value="取消">
                    <input type="submit" class="btn" id="comment_submit" value="确认评价">
                </div>
            </form>
        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(function () {
            var evlt_h = $('.shangjia_evlt_mask_box').height();
            $('.shangjia_evlt_mask_box').css("margin-top",-evlt_h/2 + 'px');

            $("#dianping_btn").click(function(){
                    $('.shangjia_evlt_mask_box').fadeIn(100);
                    $('.mask_bg').fadeIn(100);
            });
            $(".shangjia_evlt_mask .cancel,.mask_bg").click(function(){
                    $('.shangjia_evlt_mask').fadeOut(100);
                    $('.mask_bg').fadeOut(100);
            });
            
            $('.click a').click(function () {
                var rel = $(this).attr('rel');
                $(this).parent().find('input').val(rel);
                $(".starCz_bar").css('width', rel * 20 + '%');
            })
            $("#comment_form").ajaxForm({"target": "#comment_submit", "type": "post", "dataType": "json", "success": function (ret) {
                if (ret.error == 0) {
                    layer.open({content: ret.message, time: 2});
                    setTimeout(function () {
                        window.location.reload(true);
                    }, 1500);
                } else {
                    layer.open({content: ret.message, time: 2});
                    return false;
                }
            }});
            
        });
    </script>
    <!--评价弹出层end-->
    <script>
        $(document).ready(function() {
            $('.store-orderParticulars .top-lg-box .box-left .btn').mouseover(function(){
                $(this).addClass('active').siblings().removeClass('active')
            })
            
            $(".jq_cancel").click(function(){
                var order_id = "<{$detail.order_id}>";
                var link = "<{link ctl='ucenter/order/cancel' args=oooo}>";
                $.post(link.replace("oooo",order_id),{},function(ret){
                    layer.msg(ret.message);
                    if(ret.error == 0){
                        window.location.reload(true);
                    }
                },'json')
            })
        });
    </script>
<{include file="pchome/block/footer.html"}>