<{assign var='tpl_title' value=L("外卖商家列表")}>
<{include file="waimai/block/header.html"}>
<style type="text/css">
    #pubnodata{ background: #eef2f5}
    .top_appDown{z-index: 101;}
    .top_appDown ~ .takeout-list-mask{top:50px;}
    .page_cont{
        width: 100%;
        height: auto;
        position: fixed;
        z-index: 100;
    }
    /*头部*/
    .header{
        width: 100%;
        height: 50px;
        background-color: #fff;
    }
    .header .city{
        position: relative;
        float: left;
        text-align: center;
        width: 30px;
        height: 50px;
        margin: 0 auto;
    }
    /* .header .city{
        position: relative;
        float: left;
        text-align: center;
        width: 65px;
        height: 50px;
        margin: 0 auto;
    } */
    .header .city a{
        font-size: 24px;
        font-weight: bold;
        line-height: 50px;
        color: rgb(207, 124, 45);
        vertical-align: top;
    }
    .header .title{
        width: 100%;
        text-align: center;
        font-size: 18px;
        line-height: 46px;
        display: inline-block;
    }
    .header .back{
        position:absolute;
        left: 14px;
        top: 20px;
        width: 12px;
        height: 16px;
        background-image: url(../../../themes/waimai/static/images/arrow-r@2x.png);
        background-repeat: no-repeat;
        background-size: cover;
        margin-top: -6px;
        transform:rotateY(180deg);
    }
    .header .city i{
        position:absolute;
        left: 58px;
        top: 50%;
        width: 12px;
        height: 8px;
        background-image: url(../../../themes/waimai/static/img/new4.0/index/to_btn_arrowd@3x.png);
        background-repeat: no-repeat;
        background-size: cover;
        margin-top: -4px;
    }
    .header .search_ico{
        position: absolute;
        right: 15px;
        top: 14px;
        width: 18px;
        height: 18px;
        background-image: url(../../../themes/waimai/static/img/new4.0/index/icon_search@3x.png);
        background-repeat: no-repeat;
        background-size: cover;
    }
    .banner{
        width: 100%;
        margin: 0 auto;
        background-color: #fff;
    }
    .idxBanner{
        padding:12px;
    }
    .idxBanner .swiper-wrapper .swiper-slide a {
        display: block;
        width: 100%;
        padding: 19.4% 0;
        height: 0;
        background-position: center;
        background-repeat: no-repeat;
        background-size: cover;
        background-color: #f7f7f7;
        border-radius: 4px;
        overflow: hidden;
    }
    .type{
        width: 100%;
        background-color: #fff;
        margin: 0 auto;
    }
    .type ul li{
        text-align: center;
        width: 19%;
        margin: 5px auto;
        display: inline-block;
    }
    .type ul .active a span{
        border-radius: 5px;
        color: #FFF;
        background-color: rgb(236, 89, 35);
    }
    .type ul li img{
        width: 60%;
        display: inline-block;
    }
    .type ul li span{
        width: 100%;
        margin-top: 6px;
        display: inline-block;
    }
    /*.takeout-list-mask .list .fr{
        float: left;
        width: 100%;
    }*/
    .mask-list > div{
        padding-top: 41px;
    }
    .type_box{
        width: 100%;
        height: 36px;
        background-color: #fff;
        border-bottom: 1px solid #eee;
    }
    .type_box ul li{
        width: 32.6%;
        height: 36px;
        text-align: center;
        line-height: 36px;
        font-size: 16px;
        margin: 0 auto;
        display: inline-block;
    }
    .type_box ul li a{
        position: relative;
    }
    .type_box ul li a::after{
        content: "";
        position: absolute;
        top: 2px;
        left: -25px;
        width: 20px;
        height: 20px;
        background-image: url(../../../themes/waimai/static/img/new4.0/btn_radio@3x.png);
        background-size: cover;
    }
    .type_box ul .active ::after{
        background-image: url(../../../themes/waimai/static/img/new4.0/btn_radio_selected@3x.png);
    }
    .container_mid{
        margin-top: 92px;
    }
    .mask-list .list .icon_list li{height: 50px; line-height: 50px; padding-left: 50px;}
    .mask-list .list .icon_list li .s_icon{display: block; width: 32px; height: 32px; float: left; margin-left: -41px; background: center center no-repeat; margin-top: 9px; background-size: cover;}
</style>
<div class="container"  id="ScrollListener" style="position:static; height:100%;overflow-y: scroll;">
    <div class="page js_show" id="ScrollLayer" style="position: relative;">
        <div class="page_cont">
            <{include file="waimai/block/qucikly.html"}>
            <!-- 新增头部 -->
            <div class="header"><a class="back" href="javascript:history.back();"></a><!-- <div class="city"><{if false}><a id="CurSelCity">河内</a><i></i><{/if}></div>--><span class="title"><{$title}></span><a class="search_ico" href="<{link ctl='shoplist/search' arg0=1 http='waimai'}>"></a></div>
            <!-- 新增头部结束 -->
            <{if false}><!-- //禁用店铺类型 -->
            <div class="type_box">
                <ul id="TypeSel">
                    <li class="active" vcode=""><a>全部</a></li>
                    <li vcode="cn"><a>中国人店</a></li>
                    <li vcode="vn"><a>越南人店</a></li>
                </ul>
            </div>
            <{/if}>
            <div class="takeout-list-title border_b">
                <a class="list" href="javascript:;">全部分类</a>
                <span class="line"></span>
                <a class="list" href="javascript:;">排序</a>
                <{if false}>
                <span class="line"></span>
                <a class="list" href="javascript:;">筛选</a>
                <{/if}>
            </div>
        </div>
            <div class="takeout-list-mask">
                <div class="mask-list">
                    <div class="list">
                        <div class="left fl" style="background: #f4f4f4">
                            <ul>
                                <li onclick="selCate(this);" parent-id="0" self-id="0" cat-id="0"><a href="javascript:;">全部分类<span></span></a></li>
                                <{foreach $cates as $v}>
                                <{if $v.childrens}>
                                <li parent-id="<{$v.parent_id}>" cat-id="<{$v.cate_id}>" <{if $cate_id==$v.cate_id}> class="on"<{/if}>><a href="javascript:;"><{$v.title}><span></span></a></li>
                                <{else}>
                                <li onclick="selCate(this);" parent-id="<{$v.parent_id}>" self-id="<{$v.cate_id}>" cat-id="<{$v.cate_id}>" <{if $cat_id==$v.cate_id}> class="on"<{/if}> ><a href="javascript:;"><{$v.title}><span></span></a></li>
                                <{/if}>
                                <{/foreach}>
                            </ul>
                        </div>
                        <div class="right fr">
                            <ul>
                                <li class="right_list takeout_wu" style="display: none" cat-id="0">当前为全部类目</li>
                                <{foreach $cates as $cate}>
                                <li class="right_list" cat-id="<{$cate.cate_id}>" <{if $cate_id==$cate.cate_id}>style='display:block;'<{/if}>>
                                    <ul class="icon_list">
                                        <li onclick="selCate(this);" parent-id="<{$cate.cate_id}>" self-id="0" cate-id="0"><a href="javascript:;">全部</a></li>
                                        <{foreach $cate.childrens as $vo}>
                                        <li onclick="selCate(this);" parent-id="<{$vo.parent_id}>" self-id="<{$vo.cate_id}>" cate-id="<{$vo.cate_id}>"><i class="s_icon" <{if $vo.icon}>style="background-image:url('<{$pager.img}>/<{$vo.icon}>');"<{/if}>></i><a href="javascript:;"><{$vo.title}></a></li>
                                        <{/foreach}>
                                    </ul>
                                </li>
                                <{/foreach}>
                            </ul>
                        </div>
                    </div>
                    <div class="takeout_mask-bg"></div>
                </div>
                <div class="mask-list">
                    <div class="order">
                        <ul>
                            <li onclick="setloadparams('orderby','default');" orderby="default"><a href="javascript:;">智能排序</a></li>
                            <li onclick="setloadparams('orderby','juli');" orderby="juli"><a href="javascript:;">距离最近</a></li>
                            <li onclick="setloadparams('orderby','pingfen');" orderby="pingfen"><a href="javascript:;">评分最高</a></li>
                            <li onclick="setloadparams('orderby','sales');" orderby="sales"><a href="javascript:;">销售最高</a></li>
                            <li onclick="setloadparams('orderby','minprice');" orderby="minprice"><a href="javascript:;">起送价最低</a></li>
                            <{if false}><li onclick="setloadparams('orderby','song');" orderby="song"><a href="javascript:;">最早送达</a></li><{/if}>
                        </ul>
                    </div>
                    <div class="takeout_mask-bg"></div>
                </div>
                <div class="mask-list">
                    <div class="choose_box">
                        <div class="choose" id="choosebox">
                            <div class="way">
                                <p class="title black9"><!-- <i class="ico_way"></i> -->配送方式</p>
                                <div class="tips">
                                    <a href="javascript:;">不限<input type="radio" name="way" rel-key="pei_type" rel-val="0"></a>
                                    <a href="javascript:;">平台送<input type="radio" name="way" rel-key="pei_type" rel-val="2"></a>
                                    <a href="javascript:;">商家送<input type="radio" name="way" rel-key="pei_type" rel-val="1"></a>
                                </div>
                            </div>
                            <div class="infor">
                                <p class="title black9"><!-- <i class="ico_infor"></i> -->优惠信息</p>
                                <div class="tips">
                                    <a href="javascript:;">满减优惠<input type="radio" name="infor" rel-key="youhui" rel-val="mj"></a>
                                    <a href="javascript:;">满返优惠<input type="radio" name="infor" rel-key="youhui" rel-val="mf"></a>
                                    <a href="javascript:;">首单优惠<input type="radio" name="infor" rel-key="youhui" rel-val="sd"></a>
                                    <a href="javascript:;">优惠券<input type="radio" name="infor" rel-key="youhui" rel-val="yhj"></a>
                                </div>
                            </div>
                            <div class="tese">
                                <p class="title black9"><!-- <i class="ico_te"></i> -->商家特色</p>
                                <div class="tips">
                                    <a href="javascript:;">免配送费<input  type="radio" name="tese" rel-key="ts" rel-val="mian"></a>
                                    <a href="javascript:;">0元起送<input  type="radio" name="tese" rel-key="ts" rel-val="zero"></a>
                                </div>
                            </div>
                        </div>
                        <div class="btns">
                            <a href="javascript:;" class="reset_btn">清空</a>
                            <a href="javascript:;" id="confirm_btn" class="confirm_btn">确定</a>
                        </div>
                    </div>
                    <div class="takeout_mask-bg"></div>
                </div>
            </div>

            <div class="container_mid">
                <div class="shoplists_box WMhome" id="index_goods_items">
                                
                </div>
                <div class="loadding" style="">
                </div>
                <div class="pubnodata" style="">
                </div>
            </div>
            <!-- 附近推荐商铺结束 -->
        </div>
    </div>
</div>

<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script src="/static/cdn/js/swiper.min.js"></script>

<!-- Initialize Swiper -->
<script>
    // var swiper = new Swiper('.swiper-container', {
    //     pagination: '.swiper-pagination',
    //     slidesPerView: 1,
    //     paginationClickable: true,
    //     spaceBetween: 0,
    //     loop: true
    // });
</script>
<script type="text/javascript">
    //<{if false}><!-- //禁用店铺类型 -->
    //店铺类型选择筛选
    $("#TypeSel li[vcode]").on("click",function(){
        parmas.country_code = $(this).attr("vcode");
        loadshopsdata();
    });
    //<{/if}>

    $('.type_box ul li').click(function(){
        $(this).addClass('active').siblings().removeClass('active');
    });
    var cateSwiper = null;
    $('.takeout-list-mask .left ul li').click(function(){
        var tk_idx=$(this).index();
        $(this).addClass('on').siblings().removeClass('on');
        $(this).parents(".list").find('.right .right_list').eq(tk_idx).show().siblings().hide();
        var value=$(this).text();
        avalue=value.split('(');
        value=avalue[0];
        var ind=$(this).parents('.mask-list').index()
        $('.takeout-list-title .list').eq(ind).text(value);
        if($(this).parents(".list").find('.right .right_list').eq(tk_idx).find('li').length <= 1 ){
            $(this).parents(".list").find('.right .right_list').eq(tk_idx).find('li').addClass('on');
            $('.takeout-list-mask,.mask-list').hide();
            $('.takeout-list-title .list').removeClass('on')
        }
    })

    $('.takeout-list-mask .right .right_list li').click(function(){
        $(this).addClass('on').siblings().removeClass('on');
        $('.takeout-list-title .list').removeClass('on')
        $('.takeout-list-mask,.mask-list').hide()
    })

    if($('.takeout-list-title').length > 0){
        $('.takeout-list-title a.list').width(100 / $('.takeout-list-title a.list').length + '%');
    }

    $('.takeout-list-title a.list').click(function(){
        $(this).toggleClass('on').siblings().removeClass('on');
        $('.takeout-list-mask').show();
        var ind=$(this).index();
        $('.takeout-list-mask .mask-list').eq(ind/2).toggle().siblings().hide();
        if($(this).hasClass("on")){
            $('.takeout-list-mask').show();
        }else{
            $('.takeout-list-mask').hide();
        }
    })

    $('.takeout-list-mask .choose a').click(function(){
        $(this).addClass('on').siblings().removeClass('on');
    })

    $('.takeout-list-mask .choose_box .reset_btn').click(function(){
        $('.takeout-list-mask .choose a').removeClass('on');
        parmas['pei_type'] = '';
        parmas['youhui'] = '';
        parmas['ts'] = '';
    })

    $('.takeout_mask-bg').click(function(){
        $('.takeout-list-mask').hide()
        $('.takeout-list-mask .mask-list').hide();
        $('.takeout-list-title a').removeClass('on');
        addClassOn();
    })

    $('.mask-list .order li,.mask-list .choose_box li').click(function(){
        $(this).addClass('on').siblings().removeClass('on');
        $('.takeout-list-mask,.mask-list').hide();
        $('.takeout-list-title .list').removeClass('on')
    })

    //商家列表活动展开与折叠
    $(document).on('touchstart','.WMhome .shoplists .hd .right',function(e){
        event.preventDefault(); // 阻止默认事件
        event.stopPropagation(); // 阻止冒泡
        if($(this).hasClass('on')){
            $(this).parents(".hd").find("ul").removeClass('on');
            $(this).removeClass('on');
        }
        else{
            $(this).parents(".hd").find("ul").addClass('on');
            $(this).addClass('on');
        };
    });

    //商家列表加载js----------------------------------------------------------------------
    var cat_id = parseInt("<{$cate_id}>");
    cat_id = isNaN(cat_id)?0:cat_id;
    var oldFirstCateId = Number(cat_id);
    var cate_id = parseInt("<{$cat_id}>");
    cate_id = isNaN(cate_id)?0:cate_id;
    var title = "<{$title|default:''}>";
    var parmas = JSON.parse(sessionStorage['page_shoplist_parmas'] || '{"cat_id": "'+cat_id+'", "cate_id": "'+cate_id+'", "title": "'+title+'"}');
    parmas.cat_id = cat_id;
    parmas.cate_id = cate_id;
    parmas.country_code = "";

    var link = "<{link ctl='shoplist/loadshops' arg0='#page#' http='waimai'}>";
    var page = 1;
    parmas.page = page;

    var _PAGE_SHOPLIST_REBACKTOP = JSON.parse(sessionStorage['page_shoplist_rebacktop'] || '{"page":1, "top":0}');
    _PAGE_SHOPLIST_REBACKTOP['page'] = page;
    if(_PAGE_SHOPLIST_REBACKTOP['page'] > 1){
        page = page+'-'+_PAGE_SHOPLIST_REBACKTOP['page'];
        parmas['pagelimit'] = _PAGE_SHOPLIST_REBACKTOP['page'];
    }
    addClassOn();
    setTimeout(function(){
        loadshopsdata();
    },20)
    

    function setloadparams(k,v){
        if(k=='cat_id' || k==="cate_id"){
            return;
        }
        parmas[k] = v;
        $('.takeout-list-mask').hide();

        _PAGE_SHOPLIST_REBACKTOP['top'] = 0;
        parmas['pagelimit'] = 1;
        loadshopsdata();
        addClassOn();
    }

    function selCate(ele){
        var pid = Number($(ele).attr("parent-id"));
        var sid = Number($(ele).attr("self-id"));
        if(pid === 0)
        {
            pid = sid;
            sid = 0;
        }
        oldFirstCateId = Number(parmas.cat_id);
        parmas.cat_id = pid;
        parmas.cate_id = sid;
        addClassOn();
        loadshopsdata();
    }

    $('[type="radio"]').on('click',function(){
        var k = $(this).attr('rel-key');
        var v = $(this).attr('rel-val');
        parmas[k] = v;
    })

    $('#confirm_btn').on('click',function(){
        $('.takeout-list-mask').hide();
        $('.takeout-list-mask,.mask-list').hide();
        $('.takeout-list-title .list').removeClass('on');

        _PAGE_SHOPLIST_REBACKTOP['top'] = 0;
        parmas['pagelimit'] = 1;
        loadshopsdata();
    })

    function loadshopsdata(){
        loadpage(link,parmas,1,'index_goods_items','index_goods_items',function(){
            $("#ScrollLayer").scrollTop(_PAGE_SHOPLIST_REBACKTOP['top']);
            _PAGE_SHOPLIST_REBACKTOP['page'] = 1;
            sessionStorage['page_index_rebacktop'] = JSON.stringify(_PAGE_SHOPLIST_REBACKTOP);
            parmas['pagelimit'] = 1;

            scroll(link,parmas,page,"#ScrollListener","#ScrollLayer",'index_goods_items',function(){
                _PAGE_SHOPLIST_REBACKTOP['page'] = 1;
                sessionStorage['page_index_rebacktop'] = JSON.stringify(_PAGE_SHOPLIST_REBACKTOP);
            });
        });       
    }

    function addClassOn(){
        var catid = parmas['cat_id'] || 0;
        var cateid = parmas['cate_id'] || 0;
        var orderby = parmas['orderby'] || 'juli';
        var pei_type = parmas['pei_type'] || 0;
        var youhui = parmas['youhui'] || '';
        var ts = parmas['ts'] || '';

        $('.takeout-list-mask .mask-list .left li').each(function(){            
            if($(this).attr('cat-id') == catid)
                $(this).addClass('on');
            else
                $(this).removeClass('on');
        });
        $('.takeout-list-mask .mask-list .right .right_list').each(function(){            
            if($(this).attr('cat-id') == catid){
                $(this).show().siblings('.right_list').hide();
            }
        });
        $('.takeout-list-mask .mask-list .right .right_list li').each(function(){            
            if($(this).attr('cate-id') == cateid && $(this).attr('parent-id') == catid){
                $(this).addClass('on');//.siblings('li').removeClass('on');
            } else {
                $(this).removeClass('on');
            }
        });
        $('.takeout-list-mask .mask-list .order li').each(function(){           
            if($(this).attr('orderby') == orderby){ 
                $(this).addClass('on');//.siblings('li').removeClass('on');
            } else {
                $(this).removeClass('on');
            }
        });

        $('.takeout-list-mask .choose a').each(function(){
            var relkey = $(this).find('input').attr('rel-key');
            var relval = $(this).find('input').attr('rel-val');
            if(relkey == 'pei_type' && relval == pei_type){
                $(this).addClass('on');//.siblings('a').removeClass('on');
            } else {
                $(this).removeClass('on');
            }
            if(relkey == 'youhui' && relval == youhui){
                $(this).addClass('on');//.siblings('a').removeClass('on');
            }else{
                $(this).removeClass('on');
            }
            if(relkey == 'ts' && relval == ts){
                $(this).addClass('on');//.siblings('a').removeClass('on');
            } else {
                $(this).removeClass('on');
            }
        });

        if(typeof parmas !== "undefined" && typeof parmas.country_code === "string" && $.trim(parmas.country_code) !== "")
        {
            var itemEle = $("#TypeSel li[vcode='"+parmas.country_code+"']");
            if(itemEle.length > 0)
            {
                itemEle.siblings().removeClass("active");
                itemEle.addClass("active");
            }
        }

        // $("#RecCateList li").removeClass('on');
        // $("#RecCateList li").each(function(){
        //     if(Number($(this).attr('cate-id')) === Number(parmas.cate_id))
        //         $(this).addClass('on');
        //     if(Number($(this).attr("parent-id")) === Number(parmas.cat_id))
        //         $(this).css("display","inline-block");
        //     else
        //         $(this).css("display","none");
        // });
        // if(oldFirstCateId !== Number(parmas.cat_id) && cateSwiper)
        //     cateSwiper.update(true);
    }

    /*返回上次浏览位置*/
    window.onunload = function(){
        sessionStorage['page_shoplist_rebacktop'] = JSON.stringify({"page":pages, "top":$("#ScrollLayer").scrollTop()});
        sessionStorage['page_shoplist_parmas'] = JSON.stringify(parmas);
    }
    /*返回上次浏览位置*/

</script>
<script type="text/javascript">
(function(){
    $("#CurSelCity").parents(".city").eq(0).on("click",function(){
        window.location.href = "<{link ctl='position/index' http='waimai'}>";
    });
    getUxLocation(function(ret){
        if(ret.error===0)
            $('#CurSelCity').text(decodeURI(ret.addr));
    });
})();
</script>
<{include file="waimai/block/footer.html"}>