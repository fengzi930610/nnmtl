<{include file="block/header.html"}><style type="text/css">.divideGroups{overflow: hidden;}.divideGroups .add_btn{display: inline-block;margin-right: 20px;margin-bottom: 20px;color: #555;font-size: 12px;line-height: 28px;height: 30px;width: 80px;text-align: center;border: 1px dashed #bbb;cursor: pointer;}.divideGroups .list_box label{position: relative;display: inline-block;height: 30px;padding: 0 16px;color: #555;font-size: 12px;line-height: 28px;border: 1px solid #bbb;border-radius: 2px;cursor: pointer; margin-right: 10px;}.divideGroups .list_box label input{width: 0; height: 0;}.divideGroups .list_box label.on{border-color: #00bd9e;}.divideGroups .list_box label.on:before{content: " ";position: absolute;right: 0;bottom: 0;width: 0;height: 0;border: 7px solid #00bd9e;border-top-color: transparent;border-left-color: transparent;}.divideGroups .list_box label.on:after {content: " ";position: absolute;right: 1px;bottom: 3px;width: 6px;height: 3px;border: 1px solid #fff;border-top-color: transparent;border-right-color: transparent; -webkit-transform: rotate(-59deg);transform: rotate(-59deg);}.divideGroups_mask .cont{padding: 30px 20px 10px;}.divideGroups_mask .cont .int{width: 100%; height: 34px; border: 1px solid #e6e6e6; background: none; border-radius: 3px; padding-left: 10px; outline: 0; font-size: 14px;}.product_popup .products .search .sear { line-height: 0px; }.product_popup .products .content .lists { padding: 5px;}.product_popup .products .product-close { float: right; color: #ccc; font-size: 20px;}.createDiscount table .discount input, .createDiscount table .sku_num input {text-align: center;}</style><script type="text/javascript" src="%THEME%/static/js/common.js"></script><div class="breadcrumb_box">    <ol class="breadcrumb">        <li><a href="<{link ctl='index:home'}>"><i class="glyphicon glyphicon-home mr10"></i>首页</a></li>        <li><a href="<{link ctl='product/huodong/shop'}>">营销管理</a></li>        <li>折扣活动</li>        <li class="active">创建活动</li>    </ol></div><div class="wrapper-content_box">    <div class="wrapper wrapper-content createDiscount">        <!--表单-->        <div class="tabnr_change show divideGroups">            <form action="<{link ctl='huodong/discount/create'}>" mini-form="discount" method="post" target="miniframe" name="discount-form" id="discount-form">                <table class="form_table" width="100%" border="0" cellspacing="0" cellpadding="0">                                       <tr>                        <td width="120"><p class="form_table_t"><em>·</em>活动名称：</p></td>                        <td><div class="form_table_nr"><input type="text" name="data[title]" class="form_table_int form_table_intw1" /></div></td>                    </tr>                    <tr>                        <td width="120"><p class="form_table_t"><em>·</em>活动时间：</p></td>                        <td>                            <!-- <div class="form_table_nr choosedata">                                <div class="fl">                                    <input type="text" placeholder="选择开始时间 " name="data[stime]" class="fl">                                    <i class="fl"></i>                                </div>                                <span class="ml10 fl mr10">至</span>                                <div class="fl">                                    <input type="text" placeholder="选择结束时间 " name="data[ltime]" class="fl">                                    <i class="fl"></i>                                </div>                            </div> -->                            <div class="form_table_nr choosedata input-daterange" id="datepicker">                                <div class="fl">                                    <input type="text" placeholder="选择开始时间 " name="data[stime]" class="fl" value="<{date('Y-m-d')}>" readonly>                                    <i class="fl"></i>                                </div>                                <span class="ml10 fl mr10">至</span>                                <div class="fl">                                    <input type="text" placeholder="选择结束时间 " name="data[ltime]" class="fl" value="<{date('Y-m-d')}>" readonly>                                    <i class="fl"></i>                                </div>                            </div>                        </td>                    </tr>                    <tr class="list_box">                        <td width="120"><p class="form_table_t"><em>·</em>循环周期：</p></td>                        <td class="form_table_nr">                                                      <label><input type="checkbox" name="data[period_weeks][]" value="1">周一</label>                            <label><input type="checkbox" name="data[period_weeks][]" value="2">周二</label>                            <label><input type="checkbox" name="data[period_weeks][]" value="3">周三</label>                            <label><input type="checkbox" name="data[period_weeks][]" value="4">周四</label>                            <label><input type="checkbox" name="data[period_weeks][]" value="5">周五</label>                            <label><input type="checkbox" name="data[period_weeks][]" value="6">周六</label>                            <label><input type="checkbox" name="data[period_weeks][]" value="0">周日</label>                            <span>的</span>                            <label class="ml10 noborder">                                <input type="text" name="data[period_times][stime]" value="00:00" onclick="WdatePicker({dateFmt:'H:mm',minDate:'00:00',maxDate:'23:59'})" style="width:50px; display: inline; height:100%; border:none; text-align:center" class="input" readonly/>                            </label>                            <span>至</span>                            <label class="ml10 noborder">                                <input type="text" name="data[period_times][ltime]" value="23:59" onclick="WdatePicker({dateFmt:'H:mm',minDate:'00:00',maxDate:'23:59'})" style="width:50px; display: inline; height:100%; border:none; text-align:center" class="input" readonly/>                            </label>                            <!-- <label class="ml10 noborder">                                <select name="data[period_stime][]"  class="noborderSelect">                                    <option value="">00</option>                                </select>                                <input type="text" name="data[period_stime]" value="00:00" onclick="WdatePicker({dateFmt:'H:mm',minDate:'00:00',maxDate:'23:59'})" style="width:50px; display: inline; height:100%; border:none; text-align:center" class="input" readonly/>                            </label>                            <span>时</span>                            <label class="ml10 noborder">                                <select name="data[period_stime][]"  class="noborderSelect">                                    <option value="">00</option>                                </select>                            </label>                            <span>分</span>                            <span>至</span>                            <label class="ml10 noborder">                                <select name="data[period_ltime][]"  class="noborderSelect">                                    <option value="">00</option>                                </select>                            </label>                            <span>时</span>                            <label class="ml10 noborder">                                <select name="data[period_ltime][]"  class="noborderSelect">                                    <option value="">00</option>                                </select>                            </label>                            <span>分</span> -->                        </td>                    </tr>                    <tr class="limitnum">                        <td><p class="form_table_t ">限购设置：</p></td>                        <td>                            <div class="form_table_nr">                                <label class="mr30">                                    <input type="radio" name="quota" checked="checked" value="0" class="check_box" />不限购                                </label>                                <label class="mr30">                                    <input type="radio" name="quota" value="1" class="check_box fl" style="margin-top: 12px;" />                                    <span class="fl">每单商品前</span>                                    <div><input type="text" class="fl" value="0" name="data[quota]" style="text-align:center">件</div>享受优惠                                    <!-- <a class="tips" href="javascript:;"></a> -->                                </label>                            </div>                        </td>                    </tr>                    <tr class="">                        <td><p class="form_table_t ">优惠方式：</p></td>                        <td>                            <div class="form_table_nr">                                <label class="mr30"><input type="radio" name="data[discount_type]" checked="checked" value="0" class="check_box" />打折</label>                                <label class="mr30"><input type="radio" name="data[discount_type]" value="1" class="check_box" />减价</label>                            </div>                        </td>                    </tr>                                        <tr class="activitygoods">                        <td><p class="form_table_t">活动商品：</p></td>                        <td>                            <div class="form_table_nr ">                                <div class="chooseproduct" style="cursor:pointer">选择商品</div>                                <table width="100%" border="0" cellspacing="0" cellpadding="0" class="dispatch_table">                                    <tr class="tit">                                        <td>促销商品</td>                                        <td>原价</td>                                        <td>优惠</td>                                        <td>优惠后</td>                                        <td>活动库存</td>                                        <td>已售</td>                                        <td>操作</td>                                    </tr>                                    <!-- <tr class="product-tr">                                        <td>                                            <img src="/attachs/default/product.png">                                            <span>果汁饮料</span>                                            <input type="hidden" name="products[product_id][]" value="">                                        </td>                                        <td>￥<span class="money">12</span></td>                                        <td class="discount"><span class="fl mr5">打折</span><div class="fl" style="width:100px"><input type="text" class="fl" name="products[discount_value][]"><span>折</span></div></td>                                        <td class="fontcl1">￥10.80</td>                                        <td><div class="sku_num"><input type="text" name="products[sale_sku][]">件</div></td>                                        <td>0件</td>                                        <td class="right btns">                                            <input type="button" class="btn edit" value="删除">                                        </td>                                    </tr>                                    -->                                    <tr class="nodata-tr">                                        <td colspan="7" style="text-align:center; padding:20px">没有更多数据了！</td>                                    </tr>                                </table>                            </div>                        </td>                    </tr>                    <tr>                        <td><p class="form_table_t">支持场景：</p></td>                        <td><div class="form_table_nr">外卖</div></td>                    </tr>                </table>                <div class="form_table_btn_box text_c">                    <input type="hidden" id="type" name="type" value=""/>                    <input class="btn btn-primary btn-w-m sub_btn" rel="1" type="button" value="保存" />                    <!-- <input class="btn btn-primary btn-outline btn-w-m sub_btn" rel="2" type="button" value="保存并继续新建" /> -->                    <a class="btn btn-default btn-w-m" href="<{link ctl='huodong/shop/index'}>">取消</a>                </div>                        </form>        </div>        <!--表单end-->    </div>    <div id="preview" class="none"><img class="jq_preview" src="" width="200" height="200"/></div></div><!-- 选择商品弹出层 -->               <div class="product_popup">    <div class="products">        <!-- <div class="title">选择商品<a href="javascript:;" class="product-close" style="float:right">x</a></div> -->        <div class="title">选择商品<a href="javascript:;" class="fa fa-times-circle product-close"></a></div>        <div class="search">            <form action="<{link ctl='huodong/discount/product' arg0=0}>" method="post" target="productIframe" name="product-form" id="product-form">                <input type="text" placeholder="搜索商品" name="SO[title]" class="fl ml20">                <input type="submit" class="btn sear fl" value="搜索">            </form>        </div>                <div class="content">            <div class="left fl">                <ul>                    <{foreach $cates as $cate}>                        <li><a href="<{link ctl='huodong/discount/product' arg0=0 arg1=$cate.cate_id}>" target="productIframe"><{$cate.title}></a></li>                    <{/foreach}>                </ul>            </div>            <div class="lists">                <iframe src="<{link ctl='huodong/discount/product' arg0=$huodong_id}>" name="productIframe" id="productIframe" style="width:100%;height:405px;border:none"></iframe>            </div>        </div>        <div class="confirm">            <!-- <span class="black9">最多可选择10个商品</span> -->            <div style="cursor:pointer" class="confirm-btn">确定<span class="num" style="position:static; padding: 0px"></sapn></div>        </div>    </div></div><!-- 选择商品弹出层结束 --><script type="text/javascript">    $('.product_popup .products  .content .left li:first').addClass('on');    $('.product_popup .products  .content .left li').click(function(){        $(this).addClass('on').siblings().removeClass('on');    })    $('.chooseproduct').click(function(){        //$('#productIframe').attr('src', $('#productIframe').attr('src'));        $('.product_popup').show();    })    $('.product_popup .product-close').click(function(){        $('.product_popup').hide();    });    $(".sub_btn").click(function(){        $("#type").val($(this).attr('rel'));        $("form").submit();    })</script><script type="text/javascript">    var obj = {};    var addobj = {};    var discType = $('input[name="data[discount_type]"]:checked').val();    var productIframe = $("#productIframe")[0].contentWindow;//获取子窗体中的对象    $(document).ready(function(){        //$(window.frames["productIframe"].document).find();        //$('#productIframe').attr('src', $('#productIframe').attr('src'));        $(".sub_btn").click(function(){            $("#type").val($(this).attr('rel'));            $("#discount-form").submit();        })        $('.chooseproduct').click(function(){            //$('#productIframe').attr('src', $('#productIframe').attr('src'));            addobj = {};            productIframe.addobj = {};            productIframe.parentInit(obj);            productIframe.childInit(addobj);            $('.product_popup').show();        })        $('.divideGroups .list_box label input').click(function(){            if($(this).prop('checked')){//获取是否选中 并判断                $(this).parent().addClass("on"); //修改设置为不选中状态            }else{                $(this).parent().removeClass("on");//修改设置为选中状态            }        });        $(document).ready(function(){            $('input[name="quota"]').click(function(){                var val = $(this).val();                                                    $('.divideGroups .limitnum input[name="data[quota]"]').val(val);                                                });        });        $('input[name="data[discount_type]"]').click(function(){            var val = $(this).val();            discType = val;            var a = '打折';            var b = '折';            if(val > 0){                a = '减价';                b = '元';            }            $('.activitygoods table .product-tr').each(function(){                var that = $(this).find('td input[name="products[discount_value][]"]');                checkDiscVal(that);                $(this).find('td.discount span:first').text(a);                $(this).find('td.discount span:last').text(b);                            });        });        $(document).on('blur','.discount input[name="products[discount_value][]"]',function(){            checkDiscVal($(this));        });        $(document).on('click','.del-btn',function(){            var pid = $(this).attr('pid');            delete obj[pid];            delete addobj[pid];            $(this).parents('.product-tr').remove();        });        $('.confirm .confirm-btn').click(function(){            var objlen = Object.keys(obj).length;            var addobjlen = Object.keys(addobj).length;            var len = parseInt(objlen+addobjlen);                /*if(len > 10){                layer.msg('最多可选择10个商品');            }else */if(len < 1){                layer.msg('请选择活动商品');            }else{                productInit(addobj);                $('.product_popup').hide();                          }        });    });    function checkDiscVal(that){        var discount_value  = parseFloat(parseFloat(that.val()).toFixed(2));        var price = parseFloat(parseFloat(that.parents('.product-tr').find('td .money').text()).toFixed(2));        var disc_price = 0.00;                if(discType > 0){            if(price < discount_value){                discount_value = price;            }            disc_price = (price - discount_value).toFixed(2);            discount_value = discount_value.toFixed(2);        }else{            var discv = parseFloat(((discount_value/10).toFixed(2)));            discount_value = parseFloat((discv*10).toFixed(1));            if(discount_value >= 10 || discount_value < 0){                discount_value = 9.9;                discv = 0.99;            }            disc_price = (price*discv).toFixed(2);        }        that.val(discount_value);        that.parents('.product-tr').find('td .disc-price').text(disc_price);    }    function productInit(objdata){        var discountType = $('input[name="data[discount_type]"]:checked').val();        var html = '';        $.each(objdata,function(k,v){            var dprice=0;            html += '<tr class="product-tr">';            html +=     '<td>';            html +=         '<img src="<{$pager.img}>/'+v.photo+'">';            html +=         '<span>'+v.title+'</span>';            html +=         '<input type="hidden" name="products[product_id][]" value="'+v.product_id+'">';            html +=     '</td>';            html +=     '<td>￥<span class="money">'+v.price+'</span></td>';            if(discountType == 1){                dprice = v.price-0.01;                html +=     '<td class="discount"><span class="fl mr5">减价</span><div class="fl" style="width:100px"><input type="text" class="fl" name="products[discount_value][]" value="0.01"><span>元</span></div></td>';                            }else{                dprice = v.price*0.9;                html +=     '<td class="discount"><span class="fl mr5">打折</span><div class="fl" style="width:100px"><input type="text" class="fl" name="products[discount_value][]" value="9.0"><span>折</span></div></td>';            }            html +=     '<td class="fontcl1">￥<span class="disc-price">'+dprice.toFixed(2)+'</span></td>';            html +=     '<td><div class="sku_num"><input type="text" name="products[sale_sku][]" value="1">件</div></td>';            html +=     '<td>0件</td>';            html +=     '<td class="right btns">';            html +=         '<input type="button" class="btn edit del-btn" pid="'+v.product_id+'" value="删除">';            html +=     '</td>';            html += '</tr>';            obj[k] = v;        });        if(html){            $('.activitygoods table .nodata-tr').remove();            $('.activitygoods table').append(html);        }          }    </script><{include file="block/footer.html"}>