<?php/** * Copy Right IJH.CC * Each engineer has a duty to keep the code elegant * $Id$ */if(!defined('__CORE_DIR')){    exit("Access Denied");}class Ctl_Waimai_Huodong extends Ctl{    public function index($page=1)    {    	$filter = $pager = array();    	$pager['page'] = max(intval($page), 1);    	$pager['limit'] = $limit = 50;        $filter = array('closed'=>0,'audit'=>0,'ltime'=>'>=:'.__TIME);        $SO = $this->GP('SO');        $pager['SO'] = $SO;        if(is_array($SO['dateline'])){            if($SO['dateline'][0] && $SO['dateline'][1]){                $a = strtotime($SO['dateline'][0]);                $b = strtotime($SO['dateline'][1])+86400;                $filter['dateline'] = $a."~".$b;            }        }        if($SO['type']){           if($SO['type'] == 1){//首单优惠               if($items = K::M('waimai/huodongfirst')->items($filter, array('huodong_id'=>'asc'), $page, $limit, $count)){                    foreach($items as $k=>$v){                        $items[$k]['type'] = 'first';                    }                    $pager['count'] = $count;                    $pager['pagebar'] = $this->mkpage($count, $limit, $page, $this->mklink(null, array('{page}')), array('SO'=>$SO));                }           }elseif($SO['type'] == 2){//满减优惠               if($items = K::M('waimai/huodongmj')->items($filter, array('huodong_id'=>'asc'), $page, $limit, $count)){                    foreach($items as $k=>$v){                        $items[$k]['type'] = 'manjian';                    }                    $pager['count'] = $count;                    $pager['pagebar'] = $this->mkpage($count, $limit, $page, $this->mklink(null, array('{page}')), array('SO'=>$SO));                }           }elseif($SO['type'] == 3){//满返优惠               if($items = K::M('waimai/huodongmf')->items($filter, array('huodong_id'=>'asc'), $page, $limit, $count)){                    foreach($items as $k=>$v){                        $items[$k]['type'] = 'manfan';                    }                    $pager['count'] = $count;                    $pager['pagebar'] = $this->mkpage($count, $limit, $page, $this->mklink(null, array('{page}')), array('SO'=>$SO));                }           }elseif($SO['type'] == 4){//领取优惠券               if($items = K::M('waimai/huodongcoupon')->items($filter, array('huodong_id'=>'asc'), $page, $limit, $count)){                    foreach($items as $k=>$v){                        $items[$k]['type'] = 'coupon';                    }                    $pager['count'] = $count;                    $pager['pagebar'] = $this->mkpage($count, $limit, $page, $this->mklink(null, array('{page}')), array('SO'=>$SO));                }           }        }else{            if($firsts = K::M('waimai/huodongfirst')->items($filter, array('huodong_id'=>'asc'),1,5000)){                foreach($firsts as $k=>$v){                    $firsts[$k]['type'] = 'first';                }            }            if($manjians = K::M('waimai/huodongmj')->items($filter, array('huodong_id'=>'asc'),1,5000)){                foreach($manjians as $k=>$v){                    $manjians[$k]['type'] = 'manjian';                }            }            if($manfans = K::M('waimai/huodongmf')->items($filter, array('huodong_id'=>'asc'),1,5000)){                foreach($manfans as $k=>$v){                    $manfans[$k]['type'] = 'manfan';                }            }            if($coupons = K::M('waimai/huodongcoupon')->items($filter, array('huodong_id'=>'asc'),1,5000)){                foreach($coupons as $k=>$v){                    $coupons[$k]['type'] = 'coupon';                }            }            $huodong_items = array_merge($firsts,$manjians,$manfans,$coupons);            //print_r($huodong_items);die;            if($items = array_slice($huodong_items, ($page-1)*$limit, $limit, true)){                $pager['count'] = count($huodong_items);                $pager['pagebar'] = $this->mkpage($count, $limit, $page, $this->mklink(null, array('{page}')), array('SO'=>$SO));            }        }        $shop_ids = array();        foreach($items as $k=>$v){            $shop_ids[$v['shop_id']] = $v['shop_id'];        }        $this->pagedata['shops'] = K::M('waimai/waimai')->items_by_ids($shop_ids);        $this->pagedata['items'] = $items;        $this->pagedata['pager'] = $pager;        $this->tmpl = 'admin:waimai/huodong/items.html';    }    public function so()    {        $this->tmpl = 'admin:waimai/huodong/so.html';    }    public function shop($shop_id)    {        if(!$shop_id = (int)$shop_id){            $this->msgbox->add('未指定要查看的商家ID', 211);        }else if(!$waimai = K::M('waimai/waimai')->detail($shop_id)){            $this->msgbox->add('您要查看的商家不存在或已经删除', 212);        }else{            $this->pagedata['shop_id'] = $shop_id;            $filter = array('shop_id'=>$shop_id,'closed'=>0);            $first = K::M('waimai/huodongfirst')->find($filter);            $manjian = K::M('waimai/huodongmj')->find($filter);            $manfan = K::M('waimai/huodongmf')->find($filter);            $coupon = K::M('waimai/huodongcoupon')->find($filter);            $this->pagedata['first'] = $first;            $this->pagedata['coupon'] = $coupon;            $this->pagedata['manfan'] = $manfan;            $this->pagedata['manjian'] = $manjian;            $this->pagedata['waimai'] = $waimai;            $this->pagedata['nowtime'] = __TIME;            $this->tmpl = 'admin:waimai/huodong/shop.html';        }    }    public function audit($huodong_id,$type)    {        if($huodong_ids = $this->checksubmit('huodong_id')){            if(!$huodong_ids){                $this->msgbox->add('未指定需要审核的活动',201);            }else {                foreach ($huodong_ids as $kk=>$vv){                    $tmp = explode('-',$vv);                    $huodong_id = $tmp[0];                    $type = $tmp[1];                   if(!$huodong_id = (int)$huodong_id){                       $this->msgbox->add('未指定要审核的活动ID', 211)->response();                   }elseif(!$hd_type = $this->get_hd_type($type)){                       $this->msgbox->add('未指定活动类型', 212)->response();                   }elseif(!$huodong = K::M("waimai/huodong{$hd_type}")->detail($huodong_id)){                       $this->msgbox->add('活动不存在或已经下线', 213)->response();                   }elseif($huodong['audit']){                       $this->msgbox->add('活动已经审核过了', 214)->response();                   }elseif(K::M("waimai/huodong{$hd_type}")->update($huodong_id, array('audit'=>1))){                       K::M('waimai/waimai')->update_huodong_ltime($huodong['shop_id'], $hd_type);                   }else{                       $this->msgbox->add('活动审核失败', 215)->response();                   }                }                $this->msgbox->add('审核成功');            }        }else{            if(!$huodong_id = (int)$huodong_id){                $this->msgbox->add('未指定要审核的活动ID', 211);            }elseif(!$hd_type = $this->get_hd_type($type)){                $this->msgbox->add('未指定活动类型', 212);            }elseif(!$huodong = K::M("waimai/huodong{$hd_type}")->detail($huodong_id)){                $this->msgbox->add('活动不存在或已经下线', 213);            }elseif($huodong['audit']){                $this->msgbox->add('活动已经审核过了', 214);            }elseif(K::M("waimai/huodong{$hd_type}")->update($huodong_id, array('audit'=>1))){                K::M('waimai/waimai')->update_huodong_ltime($huodong['shop_id'], $hd_type);                $this->msgbox->add('活动审核成功');            }else{                $this->msgbox->add('活动审核失败', 215);            }        }    }    public function delete($huodong_id, $type)    {        if(!$huodong_id = (int)$huodong_id){            $this->msgbox->add('未指定要审核的活动ID', 211);        }elseif(!$hd_type = $this->get_hd_type($type)){            $this->msgbox->add('未指定活动类型', 212);        }elseif(!$huodong = K::M("waimai/huodong{$hd_type}")->detail($huodong_id)){            $this->msgbox->add('活动不存在或已经下线', 212);        }elseif(K::M("waimai/huodong{$hd_type}")->delete($huodong_id)){            //撤销活动时更新相应外卖店铺结束时间            K::M('waimai/waimai')->update_huodong_ltime($huodong['shop_id'], $hd_type);            $this->msgbox->add('活动撤销成功');            $this->msgbox->set_data('forward', $this->mklink('waimai/huodong:shop',array($huodong['shop_id']),array(),'admin'));        }else{            $this->msgbox->add('活动撤销失败', 218);        }    }    public function detail($huodong_id,$type)    {        if(!$huodong_id = (int)$huodong_id){            $this->msgbox->add('活动ID不能为空', 211);        }elseif(!$type = htmlspecialchars($type)){            $this->msgbox->add('未指定活动类型', 212);        }else if($type == 'first'&&!$huodong = K::M('waimai/huodongfirst')->detail($huodong_id)){            $this->msgbox->add('您要编辑的活动不存在或已经删除', 213);        }else if($type == 'manjian'&&!$huodong = K::M('waimai/huodongmj')->detail($huodong_id)){            $this->msgbox->add('您要编辑的活动不存在或已经删除', 214);        }else if($type == 'manfan'&&!$huodong = K::M('waimai/huodongmf')->detail($huodong_id)){            $this->msgbox->add('您要编辑的活动不存在或已经删除', 215);        }else if($type == 'coupon'&&!$huodong = K::M('waimai/huodongcoupon')->detail($huodong_id)){            $this->msgbox->add('您要编辑的活动不存在或已经删除', 216);        }else{            if($type == 'first'){                $html = 'admin:waimai/huodong/first/detail.html';            }elseif($type == 'manjian'){                $obj = K::M('waimai/huodongmj');                $html = 'admin:waimai/huodong/manjian/detail.html';            }elseif($type == 'manfan'){                $obj = K::M('waimai/huodongmf');                $html = 'admin:waimai/huodong/manfan/detail.html';            }elseif($type == 'coupon'){                $obj = K::M('waimai/huodongcoupon');                $html = 'admin:waimai/huodong/coupon/detail.html';            }            $this->pagedata['detail'] = $huodong;			$this->pagedata['nowtime'] = __TIME;            $this->tmpl = $html;        }    }    public function create($shop_id, $type)    {        if(!$shop_id = (int)$shop_id){            $this->msgbox->add('商家ID不能为空', 211);        }elseif(!$waimai = K::M('waimai/waimai')->detail($shop_id)){            $this->msgbox->add('商家不能为空', 212);        }elseif(!$hd_type = $this->get_hd_type($type)){            $this->msgbox->add('活动类型不正确', 213);        }elseif($curr_hd = K::M("waimai/huodong{$hd_type}")->find(array('shop_id'=>$shop_id, 'closed'=>0,'ltime'=>'>=:'.__TIME))){            $this->msgbox->add('有活动未结束', 214);        }elseif($data = $this->checksubmit('data')){            $checkfun = "check_".$hd_type;            $data['stime'] = strtotime($data['stime']);            $data['ltime'] = strtotime($data['ltime']) + 86399;                        if($data['ltime'] < __TIME){                $this->msgbox->add('结束时间不能早于当前时间', 215);            }else if($data['ltime'] < $data['stime']){                $this->msgbox->add('结束时间不能早于开始时间', 216);            }else if(!$config = $this->checksubmit('config')){                $this->msgbox->add('活动信息不能为空！',217);            }else if(!$config = $this->$checkfun($config)){                $this->msgbox->add('活动信息设置有误！',218);            }else{                $data['config'] = serialize($config);                $data['shop_id'] = $shop_id;                $data['dateline'] = __TIME;                if($huodong_id = K::M("waimai/huodong{$hd_type}")->create($data)){                    K::M('waimai/waimai')->update_huodong_ltime($shop_id, $hd_type);                    $this->msgbox->add('创建活动成功！');                }else{                    $this->msgbox->add('创建活动失败！',219);                }            }                   }else{            $this->pagedata['shop_id'] = $shop_id;            $this->pagedata['waimai'] = $waimai;            $this->tmpl = "admin:waimai/huodong/{$type}/create.html";        }    }    public function edit($huodong_id, $type)    {        if(!$huodong_id = (int)$huodong_id){            $this->msgbox->add('活动ID不能为空', 211);        }elseif(!$hd_type = $this->get_hd_type($type)){            $this->msgbox->add('活动类型不正确', 213);        }elseif(!$huodong = K::M("waimai/huodong{$hd_type}")->detail($huodong_id)){            $this->msgbox->add('活动不存在或已经删除', 214);        }else{            // if($curr_hd = K::M("waimai/huodong{$hd_type}")->find(array('shop_id'=>$huodong['shop_id'], 'closed'=>1))){            //     if($curr_hd['huodong_id'] != $huodong_id){            //         $this->msgbox->add('活动已下线不可修改', 213)->response();            //     }            // }                        if($data = $this->checksubmit('data')){                $checkfun = "check_".$hd_type;                $data['stime'] = strtotime($data['stime']);                $data['ltime'] = strtotime($data['ltime']) + 86399;                if($data['ltime'] < __TIME){                    $this->msgbox->add('结束不能早于当前', 215);                }else if($data['ltime'] < $data['stime']){                    $this->msgbox->add('结束时间不能早于开始时间', 216);                }else if(!$config = $this->checksubmit('config')){                    $this->msgbox->add('活动信息不能为空！',217);                }else if(!$config = $this->$checkfun($config)){                    $this->msgbox->add('活动信息设置有误！',218);                }else{                    $data['config'] = serialize($config);                    if(K::M("waimai/huodong{$hd_type}")->update($huodong_id, $data)){                        K::M('waimai/waimai')->update_huodong_ltime($huodong['shop_id'], $hd_type);                        $this->msgbox->add('修改活动成功！');                    }else{                        $this->msgbox->add('修改活动失败！',219);                    }                }                           }else{                $this->pagedata['huodong'] = $huodong;                $this->tmpl = "admin:waimai/huodong/{$type}/edit.html";            }        }    }    protected function get_hd_type($type)    {        if($type == 'manfan'){            return 'mf';        }elseif($type == 'manjian'){            return 'mj';        }elseif(in_array($type, array('first', 'mj', 'mf', 'coupon'))){            return $type;        }        return false;    }    protected function check_first($config)    {        $f = (float)$config['first_amount'];        $s = (float)$config['shop_amount'];        $r = (float)$config['roof_amount'];        if(!$config || !is_array($config)){            $this->msgbox->add('参数有误！',211)->response();        }/*else if(!$f){            $this->msgbox->add('请完善金额！',212)->response();        }*/else if(!$f || $f < 0 || $s < 0 || $r < 0){            $this->msgbox->add('金额填写不正确！',214)->response();        }else if($f != ($s + $r)){            $this->msgbox->add('金额填写不正确！',215)->response();        }else{            $config['first_amount'] = $f;            $config['shop_amount'] = $s;            $config['roof_amount'] = $r;            return $config;        }    }    protected function check_mj($config)    {        if(!$config || !is_array($config)){            $this->msgbox->add('参数有误！',211)->response();        }else{            $data = array();            foreach ($config as $k => $v) {                $o = (float)$v['order_amount'];                $c = (float)$v['coupon_amount'];                $s = (float)$v['shop_amount'];                $r = (float)$v['roof_amount'];                if(!$o && !$c && !$s && !$r){                    continue;                }else if(!$o || !$c){                    $this->msgbox->add('活动信息设置有误！',212)->response();                }else if($o < 0 || $c < 0 || $s < 0 || $r < 0){                    $this->msgbox->add('活动信息设置有误！',213)->response();                }else if(($o < $c) || ($c != ($s + $r))){                    $this->msgbox->add('活动信息设置有误！',214)->response();                }else{                    $v['order_amount'] = $o;                    $v['coupon_amount'] = $c;                    $v['shop_amount'] = $s;                    $v['roof_amount'] = $r;                    $data[] = $v;                }            }            return $data;        }            }    protected function check_mf($config)    {        if(!$config || !is_array($config)){            $this->msgbox->add('参数有误！',211)->response();        }else{            $data = array();            foreach ($config as $k => $v) {                $o = (float)$v['order_amount'];                $c = (float)$v['coupon_amount'];                $p = (float)$v['paid_amount'];                $d = (int)$v['day'];                if(!$o && !$c && !$p){                    continue;                }else if(!$o || !$c || !$p){                    $this->msgbox->add('活动信息设置有误！',212)->response();                }else if($o < 0 || $c < 0 || $p < 0){                    $this->msgbox->add('活动信息设置有误！',213)->response();                }else if($o < $c){                    $this->msgbox->add('活动信息设置有误！',214)->response();                }else if(!$d || !in_array($d,array(1,2,3,4,5,6,7))){                    $this->msgbox->add('活动信息设置有误！',215)->response();                }else{                    $v['order_amount'] = $o;                    $v['coupon_amount'] = $c;                    $v['paid_amount'] = $p;                    $v['day'] = $d;                    $data[] = $v;                }            }            return $data;        }       }    protected function check_coupon($config)    {        if(!$config || !is_array($config)){            $this->msgbox->add('参数有误！',211)->response();        }else{            $data = array();            foreach ($config as $k => $v) {                $o = (float)$v['order_amount'];                $c = (float)$v['coupon_amount'];                if(!$o && !$c){                    continue;                }else if(!$o || !$c){                    $this->msgbox->add('活动信息设置有误！',212)->response();                }else if($o < 0 || $c < 0){                    $this->msgbox->add('活动信息设置有误！',213)->response();                }else if($o < $c){                    $this->msgbox->add('活动信息设置有误！',214)->response();                }else if(!($d = (int)$v['day']) || !in_array($d,array(1,2,3,4,5,6,7))){                    $this->msgbox->add('活动信息设置有误！',215)->response();                }else{                    $v['order_amount'] = $o;                    $v['coupon_amount'] = $c;                    $v['day'] = $d;                    $data[] = $v;                }            }            return $data;        }    }}