window.PCFG = '';function init_print(link, is_app,shop_id) {    window.PCFG = shop_id;    return false;    var print = localStorage.getItem("JH-Print"+window.PCFG);    if (print == null) {        var print_data = {};        localStorage.setItem("JH-Print"+window.PCFG, JSON.stringify(print_data))    }    var json_format = JSON.parse(print);    var get_yun = true;    var get_local1 = true;    $.each(json_format, function (k, v) {        if (v.type == "yun") {            get_yun = false        }    });    $.each(json_format, function (k1, v1) {        if (v1.type == "local") {            get_local1 = false        }    });    if (get_yun) {        get_yunprint(link)    }    if (get_local1 && is_app == "1") {        get_local()    }}function get_yunprint(link) {    $.post(link, {}, function (e) {        if (e.error == 0) {            var print = localStorage.getItem("JH-Print"+window.PCFG);            var json_print = {};            var json_xx = false;            $.each(e.data, function (kk, vv) {                if(vv){                    var parmsa = {                        "machine_key": "yprint",                        "machine_name": vv.title,                        "port": vv.plat_id,                        "is_default": 0,                        "width": 58,                        "num": 1,                        "is_used": 1,                        "type": "yun"                    };                    json_print[vv.plat_id] = parmsa                }            });            if(!e.data){               $.each(json_print,function(k,v){                   if(v.type=='yun'){                       json_print[k] = {};                   }               });            }            setTimeout(function () {                localStorage.setItem("JH-Print"+window.PCFG, JSON.stringify(json_print))            }, 500)        }    }, "json")}function get_print_list() {    var print = localStorage.getItem("JH-Print"+window.PCFG);    if (print == null) {        print = {}    } else {        print = JSON.parse(print)    }    return print}function yun_print(order_id, link) {    if (order_id == undefined) {        layer.msg("数据错误，请稍后再试");        return false    } else {        var yun_print = localStorage.getItem("JH-Print"+window.PCFG);        var json_print = JSON.parse(yun_print);        var res = false;        if (json_print) {            $.each(json_print, function (k, v) {                if (v.machine_key == "yprint" && v.is_used == "1") {                    var num = v.num;                    var link1 = link.replace("#order_id#", order_id).replace("#num#", num).replace("#plat_id#", v.port);                    $.post(link1, {}, function (e) {                        if (e.error == '0') {                            res = true;                        }                    }, "json")                }            });            setTimeout(function(){                if (res) {                    layer.msg("数据提交成功")                }            },500);        }    }}function go_print(obj) {    var order_id = obj.getAttribute("data-id");    var url = obj.getAttribute("data-url");    if (!order_id) {        layer.msg("数据错误，请稍后再试")    }    var print = localStorage.getItem("JH-Print"+window.PCFG);    var json_print = JSON.parse(print);    var count_used = false;    var has_local = false;    $.each(json_print, function (k, v) {        if (v.type == "local") {            has_local = true        }        if (v.is_used == "1") {            count_used = true        }    });    if (!count_used) {        layer.msg("没有开启的打印机，请设置打印机再打印");        return false    }    if (has_local) {        var local_data = "http://waimai.jhcms.cn/wmbiz/order/index/print_local-"+order_id+".html" ;        $.post(local_data, {}, function (e) {            if (e.error == 0) {                $.each(json_print, function (k, v) {                    if (v.type == "local" && v.is_used == "1") {                        var data = JSON.stringify(e.data);                        var number  = parseInt(v.num);                        window.Print(v.machine_key, data,number);                    }                })            }        }, "json")    }    yun_print(order_id, url)}function auto_daying(order_id, url, data) {    if (!order_id) {        layer.msg("数据错误，请稍后再试")    }    var json_print = get_print_list();    var count_used = false;    var has_local = false;    $.each(json_print, function (k, v) {        if (v.type == "local") {            has_local = true        }        if (v.is_used == "1") {            count_used = true        }    });    if(!count_used) {        return false    }    if(has_local) {        $.each(json_print, function (k, v) {            if (v.type == "local" && v.is_used == "1") {                window.Print(v.machine_key, JSON.stringify(data), parseInt(v.num))            }        })    }    yun_print(order_id, url)}function set_used(key, val) {    var yun_print = localStorage.getItem("JH-Print"+window.PCFG);    var json_print = JSON.parse(yun_print);    if (json_print[key] == undefined) {        return false    }    json_print[key]["is_used"] = val;    setTimeout(function () {        localStorage.setItem("JH-Print"+window.PCFG, JSON.stringify(json_print));        return true    }, 500)}function set_num(machine_key, num, link, callback) {    var yun_print = localStorage.getItem("JH-Print"+window.PCFG);    var json_print = JSON.parse(yun_print);    callback = typeof(callback) == 'function' ? callback : function(){};    if (json_print[machine_key]) {        var data = {'plat_id': machine_key, 'num': num};        $.post(link, {'data': data}, function (res){            if(res.error == 0){                json_print[machine_key]["num"] = num;                setTimeout(function () {                    localStorage.setItem("JH-Print"+window.PCFG, JSON.stringify(json_print))                }, 500);                callback();            }else{                Widget.MsgBox.error(res.message);            }        },'json');            }}function init_system() {    var system = localStorage.getItem("JH-system");    if (!system) {        system = {"pc": 0, "shou": 0,'print':0};        setTimeout(function () {            localStorage.setItem("JH-system", JSON.stringify(system))        }, 200)    }}function set_system(key) {    var system = localStorage.getItem("JH-system");    var json_system = JSON.parse(system);    if (json_system) {        if (key == "pc") {            json_system["pc"] = 1;            json_system["shou"] = 0;            json_system['print'] = 0;        } else if (key == "shou") {            json_system["pc"] = 0;            json_system["shou"] = 1;            json_system['print'] = 0;        }else if(key =='print'){            json_system["pc"] = 0;            json_system["shou"] = 0;            json_system['print'] = 1;        }        setTimeout(function () {            localStorage.setItem("JH-system", JSON.stringify(json_system))        }, 500);        return true    }    return false}function systemlist() {    var system = localStorage.getItem("JH-system");    if (system) {        return JSON.parse(system)    } else {        return {"pc": 0, "shou": 0}    }}function print_shua(link, is_app) {    get_yunprint(link);    if (is_app == "1") {        get_local()    }}function get_local() {    var print = window.GetPrinterList();    var json_print = JSON.parse(print);    var yun_print = localStorage.getItem("JH-Print"+window.PCFG);    var json_format = JSON.parse(yun_print);    if (json_print) {        $.each(json_print, function (k, v) {            var parmas = {                "machine_key": v.name,                "machine_name": v.name,                "port": v.port,                "is_default": v.isDefault,                "width": 58,                "num": 1,                "is_used": 0,                "type": "local"            };            json_format[v.name] = parmas        });        console.log(JSON.stringify(json_format))        setTimeout(function () {            localStorage.setItem("JH-Print"+window.PCFG, JSON.stringify(json_format))        }, 1000)    }}function set_default_print(key) {    if (key == undefined) {        layer.msg("未指定默认打印机")    } else {        var print_string = localStorage.getItem("JH-Print"+window.PCFG);        var print_json = JSON.parse(print_string);        if (print_json[key]) {            print_json[key]["is_default"] = 1;            setTimeout(function () {                localStorage.setItem("JH-Print"+window.PCFG, JSON.stringify(print_json))            }, 500)        } else {            return false        }    }};