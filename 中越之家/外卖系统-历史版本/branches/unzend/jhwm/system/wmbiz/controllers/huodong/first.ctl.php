<?php/** * Created by PhpStorm. * User: Administrator * Date: 2017/4/6 * Time: 17:25 */if(!defined('__CORE_DIR')){    exit("Access Denied");}class Ctl_Huodong_First extends Ctl {    public function create()    {        if(K::M('waimai/huodongfirst')->count(array('shop_id'=>$this->shop_id, 'closed'=>0))){            $this->msgbox->add('已有活动，只有撤销后才能创建', 211);        }elseif($data = $this->checksubmit('data')){            $first_amount = (float)$data['first_amount'];           if(!$data['stime']){               $this->msgbox->add('请填写开始时间',212);           }else if(!$data['ltime']){               $this->msgbox->add('请填写结束时间',213);           }else if((strtotime($data['ltime'])<=(strtotime($data['stime'])))){               $this->msgbox->add('结束时间早于开始时间',214);           }else if($first_amount <= 0){               $this->msgbox->add('首单优惠不正确',215);           }else if((strtotime($data['ltime'])+86399)< __TIME){               $this->msgbox->add('结束不能早于当前时间', 216);           }else{               $first_data = array();               $first_data['shop_id'] = $this->shop_id;               $config = array(                   'first_amount' => $first_amount,                   'shop_amount'  => $first_amount,                   'roof_amount'  => 0               );               $first_data['config'] = serialize($config);               $first_data['stime'] = strtotime($data['stime']);               $first_data['ltime'] = strtotime($data['ltime'])+86399;               $first_data['type'] = $data['type'] ? 1 : 0;               $first_data['dateline'] = __TIME;               if(K::M('waimai/huodongfirst')->create($first_data)){                   $this->msgbox->add('添加首单优惠成功');                   $this->msgbox->set_data('forward', $this->mklink('huodong/shop'));               }else{                   $this->msgbox->add('添加内容失败',216);               }           }        }else{            $this->tmpl = 'huodong/first/create.html';        }    }    public function detail($huodong_id)    {        if(!$huodong_id){            $this->msgbox->add('非法数据请求',217);        }else if(!$huodong = K::M('waimai/huodongfirst')->detail($huodong_id, true)){            $this->msgbox->add('活动不存在或已删除',218);        }else{            $this->pagedata['detail'] = $huodong;            $this->pagedata['config'] = $huodong['config'];            $this->tmpl = 'huodong/first/detail.html';        }        $this->msgbox->set_data('forward', $this->mklink('huodong/shop'));    }    public function close($huodong_id)    {        if(!$huodong_id = (int)$huodong_id){            $this->msgbox->add('该活动不存在',211);        }elseif(!$detail = K::M('waimai/huodongfirst')->detail($huodong_id)){            $this->msgbox->add('该活动不存在',212);        }elseif($detail['closed'] ==1){            $this->msgbox->add('该活动已撤销',213);        }else{            if(K::M('waimai/huodongfirst')->update($huodong_id,array('closed'=>1))){              if(!K::M('waimai/waimai')->update_huodong_ltime($this->shop_id,'first')){                  K::M('waimai/huodongfirst')->update($huodong_id,array('closed'=>0));                  $this->msgbox->add('活动撤销失败',214);               }else{                  $this->msgbox->add('活动撤销成功');                  $this->msgbox->set_data('forward',$this->mklink('huodong/shop'));              }            }else{                $this->msgbox->add('活动撤销失败',214);            }        }    }    public function history($page=1)    {//历史记录        $filter = $pager = array();        $pager['page'] = $page = max((int)$page, 1);        $pager['limit'] = $limit = 10;        $filter['shop_id'] = $this->shop_id;        if($huodong_id = (int)$this->GP('huodong_id')){            $filter['huodong_id'] = "<>:".$huodong_id;        }        if($items = K::M('waimai/huodongfirst')->items($filter, array('huodong_id'=>'desc'), $page, $limit, $count)){            $pager['count'] = $count;            $pager['pagebar'] = $this->mkpage($count, $limit, $page, $this->mklink(null, array('{page}')));        }        $this->pagedata['items'] = $items;        $this->pagedata['pager'] = $pager;        $this->tmpl = 'huodong/first/history.html';    }}